# Audit Report - GUI Components (2026-01-19)

## üìä Executive Summary

- üî¥ **Critical Issues:** 3
- üü° **Warnings:** 2
- üü¢ **Suggestions:** 3
- ‚úÖ **Clean:** Kh√¥ng c√≥ TODO/FIXME, 0 l·ªói ruff

**Scope:** T√≠nh nƒÉng GUI c·ªßa javinizer-py (FastAPI + HTMX + Alpine.js)

---

## üî¥ Critical Issues (Ph·∫£i s·ª≠a ngay)

### 1. Path Traversal Vulnerability - API `/api/fs/list`

**File:** [`javinizer/web/api/filesystem.py:55`](file:///e:/Applications/javinizer-py/javinizer/web/api/filesystem.py#L55)

**V·∫•n ƒë·ªÅ:**

```python
target_path = Path(path)  # User input tr·ª±c ti·∫øp v√†o Path, kh√¥ng validate
if not target_path.exists() or not target_path.is_dir():
    raise HTTPException(status_code=404, detail="Directory not found")
```

**Nguy hi·ªÉm:**
Hacker c√≥ th·ªÉ g·ª≠i path nh∆∞ `../../../../../../etc/passwd` (Linux) ho·∫∑c `C:\Windows\System32\config\SAM` ƒë·ªÉ ƒë·ªçc file h·ªá th·ªëng b·∫•t k·ª≥ ngo√†i th∆∞ m·ª•c ƒë∆∞·ª£c ph√©p.

**C√°ch s·ª≠a:**

```python
# Add path validation
from pathlib import Path

ALLOWED_ROOTS = ["C:\\", "D:\\", "E:\\", "/"]  # Config t·ª´ settings

def validate_path(path: str) -> Path:
    """Validate that path doesn't escape allowed directories"""
    target = Path(path).resolve()
    
    # Check if path starts with any allowed root
    if not any(str(target).startswith(root) for root in ALLOWED_ROOTS):
        raise HTTPException(status_code=403, detail="Access denied")
    
    # Check for path traversal attempts
    if ".." in path:
        raise HTTPException(status_code=400, detail="Invalid path")
    
    return target

# Usage in list_directory():
target_path = validate_path(path)
```

**Priority:** üî• CRITICAL - S·ª≠a tr∆∞·ªõc khi deploy production

---

### 2. XSS Vulnerability - Inline HTML Response

**File:** [`javinizer/web/server.py:142`](file:///e:/Applications/javinizer-py/javinizer/web/server.py#L142)

**V·∫•n ƒë·ªÅ:**

```python
return f'<div class="p-4 bg-green-500/20 text-green-400 rounded-lg text-xs">Applied OK: {movie_id}</div>'
```

`movie_id` ƒë∆∞·ª£c l·∫•y t·ª´ user input (`form_data.get("movie_id")`) v√† concat tr·ª±c ti·∫øp v√†o HTML m√† kh√¥ng escape. N·∫øu user nh·∫≠p `<script>alert('XSS')</script>`, script s·∫Ω ch·∫°y tr√™n browser.

**C√°ch s·ª≠a:**

```python
from html import escape

return f'<div class="p-4 bg-green-500/20 text-green-400 rounded-lg text-xs">Applied OK: {escape(movie_id)}</div>'

# Ho·∫∑c d√πng Jinja2 template (recommended):
return templates.TemplateResponse(
    "components/apply_success.html",
    {"request": request, "movie_id": movie_id}  # Jinja2 auto-escape
)
```

**Priority:** üî• CRITICAL

---

### 3. CORS Wildcard (`allow_origins=["*"]`)

**File:** [`javinizer/web/server.py:38`](file:///e:/Applications/javinizer-py/javinizer/web/server.py#L38-L42)

**V·∫•n ƒë·ªÅ:**

```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # For dev convenience ‚Üê ƒê√ÇY
    allow_credentials=True,
    allow_methods=["*"],
)
```

Comment "For dev convenience" ch·ª©ng t·ªè ƒë√¢y l√† config DEV nh∆∞ng l·∫°i n·∫±m trong production code. B·∫•t k·ª≥ website n√†o c≈©ng c√≥ th·ªÉ g·ªçi API c·ªßa b·∫°n.

**Nguy hi·ªÉm:**

- Phishing site c√≥ th·ªÉ d√πng API c·ªßa b·∫°n ƒë·ªÉ th·ª±c hi·ªán c√°c operations
- CSRF attacks

**C√°ch s·ª≠a:**

```python
import os

# Use environment variable
allowed_origins = os.environ.get("ALLOWED_ORIGINS", "http://localhost:8001").split(",")

app.add_middleware(
    CORSMiddleware,
    allow_origins=allowed_origins,  # Ch·ªâ cho ph√©p origins c·ª• th·ªÉ
    allow_credentials=True,
    allow_methods=["POST", "GET"],  # Limit methods
    allow_headers=["Content-Type"],
)
```

**Priority:** üî• CRITICAL (n·∫øu deploy public)

---

## üü° Warnings (N√™n s·ª≠a)

### 4. Kh√¥ng c√≥ Rate Limiting

**File:** To√†n b·ªô API endpoints

**V·∫•n ƒë·ªÅ:**
Kh√¥ng c√≥ rate limiting cho c√°c endpoints nh∆∞:

- `/api/ops/batch/sort` - C√≥ th·ªÉ trigger h√†ng trƒÉm jobs c√πng l√∫c
- `/api/fs/list` - C√≥ th·ªÉ spam ƒë·ªÉ t√¨m sensitive folders
- `/api/settings` - C√≥ th·ªÉ spam ƒë·ªÉ thay ƒë·ªïi config

**C√°ch s·ª≠a:**

```python
# Install: pip install slowapi
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address
from slowapi.errors import RateLimitExceeded

limiter = Limiter(key_func=get_remote_address)
app.state.limiter = limiter
app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)

# √Åp d·ª•ng cho endpoints:
@router.post("/sort")
@limiter.limit("5/minute")  # Max 5 requests/minute
async def trigger_sort(request: Request, req: SortRequest, ...):
    ...
```

**Priority:** üü° Medium

---

### 5. Settings API Kh√¥ng C√≥ Authentication

**File:** [`javinizer/web/api/settings.py`](file:///e:/Applications/javinizer-py/javinizer/web/api/settings.py)

**V·∫•n ƒë·ªÅ:**

```python
@router.post("/")
def update_settings(new_settings: dict):  # Kh√¥ng c√≥ auth check
    save_settings(updated_settings)
```

B·∫•t k·ª≥ ai c≈©ng c√≥ th·ªÉ POST l√™n `/api/settings` ƒë·ªÉ thay ƒë·ªïi to√†n b·ªô config (proxy, scrapers, output paths...).

**Nguy hi·ªÉm:**

- Hacker c√≥ th·ªÉ redirect output folder v·ªÅ server c·ªßa h·ªç
- Thay ƒë·ªïi proxy ƒë·ªÉ intercept traffic

**C√°ch s·ª≠a:**

```python
from fastapi import Depends, HTTPException
from fastapi.security import HTTPBasic, HTTPBasicCredentials
import secrets

security = HTTPBasic()

def verify_admin(credentials: HTTPBasicCredentials = Depends(security)):
    correct_username = secrets.compare_digest(credentials.username, "admin")
    correct_password = secrets.compare_digest(credentials.password, os.getenv("ADMIN_PASSWORD", "changeme"))
    if not (correct_username and correct_password):
        raise HTTPException(status_code=401, detail="Unauthorized")
    return credentials.username

@router.post("/")
def update_settings(new_settings: dict, admin: str = Depends(verify_admin)):
    ...
```

**Priority:** üü° High (n·∫øu expose ra internet)

---

## üü¢ Suggestions (T√πy ch·ªçn, c·∫£i thi·ªán UX/Performance)

### 6. Job Manager Kh√¥ng C√≥ TTL (Time-To-Live)

**File:** [`javinizer/web/services/job_manager.py`](file:///e:/Applications/javinizer-py/javinizer/web/services/job_manager.py)

**V·∫•n ƒë·ªÅ:**
Job dictionary (`self.jobs`) l∆∞u to√†n b·ªô jobs m√£i m√£i, kh√¥ng auto-cleanup. N·∫øu ch·∫°y app l√¢u d√†i, memory s·∫Ω tr√†n.

**C√°ch s·ª≠a:**

```python
from datetime import datetime, timedelta

def cleanup_old_jobs(self, max_age_hours: int = 24):
    """Remove jobs older than max_age_hours"""
    cutoff = datetime.now() - timedelta(hours=max_age_hours)
    old_jobs = [
        jid for jid, job in self.jobs.items()
        if job.created_at < cutoff and job.status in ["completed", "failed"]
    ]
    for jid in old_jobs:
        del self.jobs[jid]
```

G·ªçi `cleanup_old_jobs()` trong background task m·ªói 1 gi·ªù.

**Priority:** üü¢ Low (ch·ªâ ·∫£nh h∆∞·ªüng n·∫øu ch·∫°y production li√™n t·ª•c)

---

### 7. Pagination Cho File Explorer

**File:** [`javinizer/web/api/filesystem.py:16`](file:///e:/Applications/javinizer-py/javinizer/web/api/filesystem.py#L16)

**V·∫•n ƒë·ªÅ:**
`list_directory()` tr·∫£ v·ªÅ T·∫§T C·∫¢ files trong folder. N·∫øu folder c√≥ 10,000 files ‚Üí response s·∫Ω r·∫•t l·ªõn v√† ch·∫≠m.

**C√°ch s·ª≠a:**

```python
@router.get("/list", response_model=List[FileItem])
async def list_directory(
    path: Optional[str] = None, 
    q: Optional[str] = None,
    limit: int = 100,  # Default 100 items
    offset: int = 0
):
    # ... existing code ...
    
    # Paginate results
    items = items[offset:offset+limit]
    return items
```

Frontend c·∫ßn implement infinite scroll ho·∫∑c "Load More" button.

**Priority:** üü¢ Low (ch·ªâ c·∫ßn n·∫øu users c√≥ folders l·ªõn)

---

### 8. Logging Thi·∫øu Request Context

**File:** Multiple files

**V·∫•n ƒë·ªÅ:**
Logs hi·ªán t·∫°i kh√¥ng ghi l·∫°i `request_id`, `user_ip`, kh√≥ debug khi c√≥ nhi·ªÅu requests ƒë·ªìng th·ªùi.

**C√°ch s·ª≠a:**

```python
# Add middleware in server.py
import uuid
from fastapi import Request

@app.middleware("http")
async def log_requests(request: Request, call_next):
    request_id = str(uuid.uuid4())
    request.state.request_id = request_id
    
    logger.info(f"[{request_id}] {request.method} {request.url.path} from {request.client.host}")
    response = await call_next(request)
    logger.info(f"[{request_id}] Completed with status {response.status_code}")
    
    return response
```

**Priority:** üü¢ Low (quality of life improvement)

---

## üì¶ Dependencies Security

**Checked:** `fastapi`, `uvicorn`, `jinja2`, `pydantic`, `httpx`

‚úÖ **Result:** Kh√¥ng c√≥ outdated packages (command tr·∫£ v·ªÅ empty)

**Note:** N√™n setup Dependabot ho·∫∑c `pip-audit` trong CI/CD ƒë·ªÉ auto-detect vulnerabilities.

---

## üìù Code Quality Summary

‚úÖ **Ruff Linting:** 0 errors (ƒë√£ ch·∫°y `ruff check javinizer/web/`)
‚úÖ **TODO/FIXME:** Kh√¥ng c√≥ tech debt ƒë∆∞·ª£c ghi ch√∫
‚úÖ **Code Duplication:** Minimal (m·ªôt s·ªë logic validation c√≥ th·ªÉ extract th√†nh helper)
‚ö†Ô∏è **Type Hints:** Kh√¥ng ƒë·∫ßy ƒë·ªß 100% (m·ªôt s·ªë `dict` ch∆∞a d√πng TypedDict)

---

## üéØ Priority Roadmap

### Week 1 (CRITICAL)

1. ‚úÖ Fix path traversal vulnerability
2. ‚úÖ Fix XSS in apply_metadata
3. ‚ö†Ô∏è Review CORS policy (n·∫øu deploy public)

### Week 2 (HIGH)

4. ‚öôÔ∏è Add basic authentication cho `/api/settings`
2. ‚öôÔ∏è Implement rate limiting

### Week 3+ (NICE TO HAVE)

6. üßπ Job cleanup task
2. üßπ Pagination cho file explorer
3. üßπ Enhanced logging with request context

---

## üîß Testing Recommendations

**C·∫ßn test:**

1. **Path Traversal:** Th·ª≠ request `/api/fs/list?path=../../etc` v√† verify b·ªã reject
2. **XSS:** Submit metadata v·ªõi `<script>alert(1)</script>` v√† verify ƒë∆∞·ª£c escape
3. **Rate Limit:** Spam `/api/ops/batch/sort` 10 l·∫ßn/gi√¢y v√† verify b·ªã block
4. **Auth:** Try POST `/api/settings` without credentials ‚Üí 401

**Tool ƒë·ªÉ test:**

- OWASP ZAP (auto scan vulnerabilities)
- Burp Suite Community (manual testing)
- `pytest-security` cho automated checks

---

## üìö Documentation Status

‚úÖ **API Endpoints:** C√≥ docstrings cho t·∫•t c·∫£ endpoints
‚ö†Ô∏è **Security Best Practices:** Ch∆∞a c√≥ t√†i li·ªáu cho admins
‚ö†Ô∏è **Deployment Guide:** Ch∆∞a c√≥ h∆∞·ªõng d·∫´n secure deployment

**N√™n t·∫°o:**

- `docs/SECURITY.md` - Security checklist tr∆∞·ªõc khi deploy
- `docs/DEPLOYMENT.md` - Production deployment guide v·ªõi HTTPS, firewall, etc.

---

## ‚úÖ What's Good (Praise!)

1. ‚ú® **Clean Architecture:** Router-based structure r·∫•t d·ªÖ maintain
2. ‚ú® **Pydantic Models:** Data validation ƒë√£ d√πng Pydantic, t·ªët!
3. ‚ú® **Error Handling:** ƒê√£ c√≥ try-catch v√† HTTPException ·ªü nhi·ªÅu ch·ªó
4. ‚ú® **No Code Smell:** Kh√¥ng c√≥ TODO/FIXME b·ªã b·ªè qu√™n
5. ‚ú® **Modern Stack:** FastAPI + HTMX + Alpine.js l√† combo tuy·ªát v·ªùi

---

## üèÅ Conclusion

GUI c√≥ foundation t·ªët, nh∆∞ng **c·∫ßn s·ª≠a 3 l·ªói Critical tr∆∞·ªõc khi deploy production**.

N·∫øu ch·ªâ ch·∫°y local (localhost) th√¨ r·ªßi ro th·∫•p, nh∆∞ng n·∫øu expose ra internet (ngrok, cloudflare tunnel, VPS) th√¨ **PH·∫¢I s·ª≠a ngay**.

**Overall Risk Level:**

- üü¢ **Local Development:** Low risk
- üü° **Local Network (LAN):** Medium risk
- üî¥ **Public Internet:** High risk (n·∫øu ch∆∞a fix)

---

**Audit by:** Antigravity Code Auditor  
**Date:** 2026-01-19  
**Next Review:** 2026-02-19 (ho·∫∑c sau khi fix Critical issues)
